# Issue #4: Check SQLite FTS5 Support

**Priority**: ðŸ”´ Critical (P1)
**Status**: âœ… Closed
**Assignee**: Claude
**Estimate**: 1 hour
**Actual**: 0.5 hours
**Created**: 2024-11-15
**Updated**: 2024-11-15
**Closed**: 2024-11-15

---

## Summary

No check for SQLite FTS5 support before creating tables, causing cryptic errors on systems without FTS5.

## Resolution

âœ… **FIXED** - Added FTS5 capability check during database initialization

### Implementation Details

**Files Modified**:
- `research_agent/storage/state.py` - Added FTS5 check in `_init_db()`

### Features Implemented
- âœ… Query `PRAGMA compile_options` on database init
- âœ… Check for FTS5 in compile options
- âœ… Raise RuntimeError with clear message if FTS5 missing
- âœ… Provide platform-specific installation instructions
- âœ… Fail fast before any database corruption

### Commits
- `68ae1d3` - FTS5 support check implementation

---

## Acceptance Criteria

- [x] Check for FTS5 support on init
- [x] Clear error message with install instructions
- [x] Platform-specific guidance (macOS, Linux, Windows)
- [x] Fail before creating any tables

## Implementation Code

```python
# research_agent/storage/state.py

def _init_db(self):
    """Initialize database and check for FTS5 support."""

    # Check FTS5 support
    with self._get_conn() as conn:
        cursor = conn.execute("PRAGMA compile_options")
        options = [row[0] for row in cursor.fetchall()]
        has_fts5 = any('FTS5' in opt for opt in options)

        if not has_fts5:
            raise RuntimeError(
                "SQLite does not have FTS5 support enabled.\n"
                "Please install SQLite with FTS5:\n"
                "  macOS: brew install sqlite3\n"
                "  Ubuntu/Debian: apt-get install sqlite3\n"
                "  Windows: Download from https://www.sqlite.org/download.html"
            )

    # Create schema
    self._create_schema()
```

## Error Message Example

```
RuntimeError: SQLite does not have FTS5 support enabled.
Please install SQLite with FTS5:
  macOS: brew install sqlite3
  Ubuntu/Debian: apt-get install sqlite3
  Windows: Download from https://www.sqlite.org/download.html
```

## Test Requirements

**Unit Tests** (deferred to Sprint 002):
- [ ] Test with FTS5 enabled (should succeed)
- [ ] Test without FTS5 (should raise RuntimeError)
- [ ] Test error message content
- [ ] Mock PRAGMA compile_options response

**Integration Tests**:
- [ ] Verify check runs before schema creation
- [ ] Verify database not created if FTS5 missing

## Technical Notes

FTS5 (Full-Text Search 5) is required for:
- Content-based deduplication using BM25 similarity
- Fast text search across items
- Title similarity detection

Most modern SQLite installations include FTS5, but some minimal/embedded builds may not.

## References

- [BUG_REPORT.md](../../../../BUG_REPORT.md) #4
- [TASK_LIST.md](../../../../TASK_LIST.md) Task 1.4
- [Sprint 001](../../sprints/SPRINT_001.md)
- [SQLite FTS5 Documentation](https://www.sqlite.org/fts5.html)
